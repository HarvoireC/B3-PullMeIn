name: Build, Validate and Deploy static site

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  validate:
    name: Validate contribution and HTML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Determine changed article files
        id: diff
        shell: bash
        run: |
          set -e
          BASE_REF=""
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_REF="origin/${{ github.base_ref }}"
            git fetch origin "${{ github.base_ref }}" --depth=1
          else
            # For push, compare to previous commit
            BASE_REF="HEAD^"
          fi
          CHANGED=$(git diff --name-only "$BASE_REF" HEAD -- 'Maquette - site/article_detail_page/*.html' || true)
          # Fallback for new branches or first commits
          if [[ -z "$CHANGED" && "${{ github.event_name }}" != "pull_request" ]]; then
            CHANGED=$(git ls-files 'Maquette - site/article_detail_page/*.html' || true)
          fi
          echo "Changed article files:\n$CHANGED"
          # Store as JSON array for Python
          printf '%s' "files=$(jq -R -s -c 'split("\n") | map(select(length>0))' <<< \"$CHANGED\")" >> $GITHUB_OUTPUT

      - name: Run repository checks
        shell: bash
        env:
          FILES_JSON: ${{ steps.diff.outputs.files }}
        run: |
          python - << 'PY'
          import json, os, re, sys
          from pathlib import Path

          # Load list of changed files
          files = json.loads(os.environ.get('FILES_JSON','[]'))

          repo_root = Path('.')
          site_root = repo_root / 'Maquette - site'
          articles_dir = site_root / 'article_detail_page'
          home_page = site_root / 'articles_home_page' / 'HomePage.html'

          errors = []

          # Utility to read file text safely
          def read_text(p: Path) -> str:
            try:
              return p.read_text(encoding='utf-8', errors='ignore')
            except Exception as e:
              errors.append(f"Impossible de lire le fichier: {p}: {e}")
              return ''

          # If there are changed/added article files, validate each
          for f in files:
            p = Path(f)
            if not p.exists():
              # Deleted or renamed away; skip
              continue
            content = read_text(p)
            relname = p.name

            # 1) Basic HTML skeleton
            if '<!DOCTYPE html' not in content[:300].lower():
              errors.append(f"{relname}: Le fichier doit commencer par <!DOCTYPE html>.")
            if '<title>' not in content.lower() or '</title>' not in content.lower():
              errors.append(f"{relname}: Le fichier doit contenir une balise <title>.")

            # 2) Required verification markers
            # Either a class containing a 22-char hex inside any div.class
            # or the special automated check class name.
            hex22 = re.compile(r'<div[^>]*class=["\"][^"\"]*[0-9a-fA-F]{22}[^"\"]["\"][^>]*>', re.IGNORECASE)
            has_hex22 = bool(hex22.search(content))
            has_ai_marker = 'class="mydevcantcodewithoutai"' in content or "class='mydevcantcodewithoutai'" in content
            if not (has_hex22 or has_ai_marker):
              errors.append(f"{relname}: Ajoutez un <div> avec une classe contenant un code hexa de 22 caractères OU la classe 'mydevcantcodewithoutai'.")

            # 3) Must contain at least 2 images (une image + une miniature minimale)
            img_count = len(re.findall(r'<img\b', content, flags=re.IGNORECASE))
            if img_count < 2:
              errors.append(f"{relname}: L'article doit contenir au minimum 2 images (image et miniature). Trouvé: {img_count}.")

            # 4) Check HomePage listing includes a link to this file
            if home_page.exists():
              hp = read_text(home_page)
              # In instructions, link format uses ./articles/[file].html but repo structure is different.
              # We'll accept any href that ends with the article filename.
              if relname not in hp:
                errors.append(f"HomePage.html: Aucun lien trouvé vers l'article {relname}. Ajoutez la carte d'article avec le bouton 'Read Article'.")
            else:
              errors.append("HomePage.html introuvable dans 'Maquette - site/articles_home_page'.")

          # If this is a PR and no article files were modified, just run a light site sanity check
          if not files:
            # check required directories exist
            if not site_root.exists():
              errors.append("Le répertoire 'Maquette - site' est introuvable.")

          if errors:
            print("\nERREURS DE VALIDATION:\n- " + "\n- ".join(errors))
            sys.exit(1)
          else:
            print("Validation réussie: structure et contenu minimum conformes.")
          PY

  deploy:
    name: Deploy to GitHub Pages
    if: github.event_name == 'push'
    needs: validate
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'Maquette - site'

      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
